<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Microsoft_logo.svg/2000px-Microsoft_logo.svg.png">

  <title>
    
      Python Build a predictive model
    
  </title>
  <meta name="description" content="Get Started with SQL Server Machine Learning Services">
  <link rel="stylesheet" href="/en-us/sql-server/developer-get-started/ml-tutorials/assets/main.css">
  <link rel="canonical" href="https://sqlchoice.azurewebsites.net/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction/step/3">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62780441-15', 'auto');
  ga('send', 'pageview');
  $(document).ready(function() {
      $("code").bind({
          copy: function(event) {
              ga("send", "event", {
                  eventCategory: window.location.pathname,
                  eventAction: "copy_code"
              });
         console.log("Copy");

          }, 

          cut: function(event) {
              ga("send", "event", {
                  eventCategory: window.location.pathname,
                  eventAction: "copy_code"
              });
          }
      })

      $("a").click(function(event) {
          ga("send", "event", {
              eventCategory: window.location.pathname,
              eventAction: "click_link",
              eventLabel: event.target.href
          });
      })
  });  
  </script>



</head>


  <body>

    <header class="sql-header sql-header--empty" role="banner">
    <div class="sql-header-content">
      <img class="sql-header-micro" src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/images/micro-logo.png" alt="Microsoft logo">
      
        <div class="sql-menutop">
          <a class="sql-menutop-link" href="/en-us/sql-server/developer-get-started/ml-tutorials/">Get started with Machine Learning in SQL Server</a>
          <div>
            
              
              

              <div class="sql-menutop-sub ">
                  
                    
                      
                      

                        
                          <span class="sql-menutop-link">R </span>
                        

                        
                    
                      
                      

                        

                        
                          <div class="sql-menutop-items">
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/R/rentalprediction" 
                                target="_self">
                                Predict ski rentals
                                
                              </a>
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/R/customerclustering" 
                                target="_self">
                                Perform customer clustering
                                
                              </a>
                            
                          </div>
                        
                    
                  
              </div>
            
              
              

              <div class="sql-menutop-sub  is-active ">
                  
                    
                      
                      

                        
                          <span class="sql-menutop-link">Python </span>
                        

                        
                    
                      
                      

                        

                        
                          <div class="sql-menutop-items">
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction" 
                                target="_self">
                                Predict ski rentals
                                
                              </a>
                            
                              
                              
                              

                              <a class="sql-menutop-item " 
                                href="/en-us/sql-server/developer-get-started/ml-tutorials/python/customerclustering" 
                                target="_self">
                                Perform customer clustering
                                
                                  <i class="sql-new"></i>
                                
                              </a>
                            
                          </div>
                        
                    
                  
              </div>
            
          </div>
        </div>

      
</header>


    <main class="sql-main" aria-label="Content">
      <div class="u-wrapper">
        <article class="sql-page_steps">

  
    
    
    

    <h1 class="sql-page_steps-hero">
      Build a predictive model using Python and SQL Server ML Services
    </h1>

    <header class="sql-page_steps-steps js-stepsheader">
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction"
               target="_self">
               <span class="sql-page_steps-number">1</span>
               Set up your environment
              </a>
          
        </div>
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction/step/2.html"
               target="_self">
               <span class="sql-page_steps-number">2</span>
               Create your ML script using Python
            </a>
          
        </div>
      
        
        

        <div class="sql-page_steps-step">
          
            <a class="sql-page_steps-link  sql-page_steps-link--active "
               href="/en-us/sql-server/developer-get-started/ml-tutorials/python/rentalprediction/step/3.html"
               target="_self">
               <span class="sql-page_steps-number">3</span>
               Deploy your ML script with SQL Server
            </a>
          
        </div>
      
    </header>
  

  <div class="sql-page_steps-loading js-loading">
    <p></p>
    <p></p>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    <div></div>
    <p></p>
    <div></div>
    <div></div>
    <p></p>
    <p></p>
    <div></div>
    <div></div>
    
  </div>

  <div class="js-steps is-hidden">
    <blockquote>
  <p>In this section, we will move the Python code we just wrote to SQL Server and deploy our predictive model with the help of SQL Server Machine Learning Services.
To deploy a model, you store the model in a hosting environment (like a database) and implement a prediction function that uses the model to predict.  That function can be called from applications.</p>
</blockquote>

<p>SQL Server ML Services enables you to train and test predictive models in the context of SQL Server. You author T-SQL programs that contain embedded Python scripts, and the SQL Server database engine takes care of the execution. Because it executes in SQL Server, your models can easily be trained against data stored in the database.
To deploy, you store your model in the database and create a stored procedure that predicts using the model.</p>

<h2 id="step-31-create-a-table-for-storing-the-model">Step 3.1 Create a table for storing the model</h2>

<p>In SSMS, launch a new query window and run the following T-SQL script:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="n">USE</span> <span class="n">TutorialDB</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">rental_py_models</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rental_py_models</span> <span class="p">(</span>
	<span class="n">model_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span><span class="p">(</span><span class="s1">'default model'</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">model</span> <span class="n">VARBINARY</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
<span class="k">GO</span>
</code></pre>
</div>
<blockquote>
  <p>You now have a table where the model can be saved.</p>
</blockquote>

<h2 id="step-32-create-stored-procedure-for-generating-the-model">Step 3.2 Create stored procedure for generating the model</h2>

<p>We are now going to create a stored procedure in SQL Server to use the Python code we wrote in the previous module and generate the linear regression model inside the database.
The Python code will be embedded in the TSQL statement.</p>

<p>Now create the stored procedure to train/generate the model</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- Stored procedure that trains and generates a Python model using the rental_data and a decision tree algorithm</span>
<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">generate_rental_py_model</span><span class="p">;</span>
<span class="k">go</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">generate_rental_py_model</span> <span class="p">(</span><span class="o">@</span><span class="n">trained_model</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="k">OUTPUT</span><span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
    <span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>
      <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Python'</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'
from sklearn.linear_model import LinearRegression
import pickle

df = rental_train_data

# Get all the columns from the dataframe.
columns = df.columns.tolist()

# Store the variable well be predicting on.
target = "RentalCount"


        
# Initialize the model class.
lin_model = LinearRegression()

# Fit the model to the training data.
lin_model.fit(df[columns], df[target])

#Before saving the model to the DB table, we need to convert it to a binary object
trained_model = pickle.dumps(lin_model)'</span>

<span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'select "RentalCount", "Year", "Month", "Day", "WeekDay", "Snow", "Holiday" from dbo.rental_data where Year &lt; 2015'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'rental_train_data'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@trained_model varbinary(max) OUTPUT'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">trained_model</span> <span class="o">=</span> <span class="o">@</span><span class="n">trained_model</span> <span class="k">OUTPUT</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>

<span class="c1">--STEP 3 - Save model to table </span>
<span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="n">rental_py_models</span><span class="p">;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">model</span> <span class="n">VARBINARY</span><span class="p">(</span><span class="k">MAX</span><span class="p">);</span>
<span class="k">EXEC</span> <span class="n">generate_rental_py_model</span> <span class="o">@</span><span class="n">model</span> <span class="k">OUTPUT</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">rental_py_models</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'linear_model'</span><span class="p">,</span> <span class="o">@</span><span class="n">model</span><span class="p">);</span>

</code></pre>
</div>

<blockquote>
  <p>The model is now saved in the database as a binary object.</p>
</blockquote>

<h2 id="step-33-create-stored-procedure-for-prediction">Step 3.3 Create stored procedure for prediction</h2>

<p>We are now very close to deploying our predicting model so that we can consume it from our applications.
This last step includes creating a stored procedure that uses our model to predict the rental count.</p>

<ol>
  <li>Create a stored procedure that predicts using our model</li>
</ol>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">py_predict_rentalcount</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">py_predict_rentalcount</span> <span class="p">(</span><span class="o">@</span><span class="n">model</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
	<span class="k">DECLARE</span> <span class="o">@</span><span class="n">py_model</span> <span class="n">varbinary</span><span class="p">(</span><span class="k">max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">model</span> <span class="k">from</span> <span class="n">rental_py_models</span> <span class="k">where</span> <span class="n">model_name</span> <span class="o">=</span> <span class="o">@</span><span class="n">model</span><span class="p">);</span>

	<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span> 
				<span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Python'</span><span class="p">,</span>
				<span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'

# Import the scikit-learn function to compute error.
from sklearn.metrics import mean_squared_error
import pickle
import pandas as pd

rental_model = pickle.loads(py_model)
  
df = rental_score_data

# Get all the columns from the dataframe.
columns = df.columns.tolist()

# variable we will be predicting on.
target = "RentalCount"

# Generate our predictions for the test set.
lin_predictions = rental_model.predict(df[columns])
print(lin_predictions)

# Compute error between our test predictions and the actual values.
lin_mse = mean_squared_error(lin_predictions, df[target])
#print(lin_mse)

predictions_df = pd.DataFrame(lin_predictions)

OutputDataSet = pd.concat([predictions_df, df["RentalCount"], df["Month"], df["Day"], df["WeekDay"], df["Snow"], df["Holiday"], df["Year"]], axis=1)
'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Select "RentalCount", "Year" ,"Month", "Day", "WeekDay", "Snow", "Holiday"  from rental_data where Year = 2015'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">input_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'rental_score_data'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">params</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'@py_model varbinary(max)'</span>
<span class="p">,</span> <span class="o">@</span><span class="n">py_model</span> <span class="o">=</span> <span class="o">@</span><span class="n">py_model</span>
<span class="k">with</span> <span class="k">result</span> <span class="k">sets</span> <span class="p">((</span><span class="nv">"RentalCount_Predicted"</span> <span class="n">float</span><span class="p">,</span> <span class="nv">"RentalCount"</span> <span class="n">float</span><span class="p">,</span> <span class="nv">"Month"</span> <span class="n">float</span><span class="p">,</span><span class="nv">"Day"</span> <span class="n">float</span><span class="p">,</span><span class="nv">"WeekDay"</span> <span class="n">float</span><span class="p">,</span><span class="nv">"Snow"</span> <span class="n">float</span><span class="p">,</span><span class="nv">"Holiday"</span> <span class="n">float</span><span class="p">,</span> <span class="nv">"Year"</span> <span class="n">float</span><span class="p">));</span>
			  
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre>
</div>
<ol>
  <li>Create a table for storing the predictions
    <div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">py_rental_predictions</span><span class="p">];</span>
<span class="k">GO</span>
<span class="c1">--Create a table to store the predictions in</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">py_rental_predictions</span><span class="p">](</span>
 <span class="p">[</span><span class="n">RentalCount_Predicted</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="n">RentalCount_Actual</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="k">Month</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="k">Day</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="n">WeekDay</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="n">Snow</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="n">Holiday</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span><span class="p">,</span>
 <span class="p">[</span><span class="k">Year</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
<span class="k">GO</span>
</code></pre>
    </div>
  </li>
  <li>Execute the stored procedure to predict rental counts</li>
</ol>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="n">py_rental_predictions</span><span class="p">;</span>
<span class="c1">--Insert the results of the predictions for test set into a table</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">py_rental_predictions</span>
<span class="k">EXEC</span> <span class="n">py_predict_rentalcount</span> <span class="s1">'linear_model'</span><span class="p">;</span>

<span class="c1">-- Select contents of the table</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">py_rental_predictions</span><span class="p">;</span>
</code></pre>
</div>

<blockquote>
  <p>Congrats, you just deployed a predictive model in SQL Server using Python!</p>
</blockquote>

  </div>

   
    
    

          

            <a class="sql-page_steps-next" href="https://docs.microsoft.com/en-us/sql/advanced-analytics/tutorials/machine-learning-services-tutorials">More SQL Server ML Tutorials</a>

          
      <div class="sql-resources">
    <header class="sql-resources-header">
        <h3 class="sql-resources-title">
            To get general documentations
        </h3>
        <a class="sql-resources-button"
            target="_blank"
            href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/r-services">
            Read the SQL Server ML Services documentation
        </a>
    </header>

    <div class="sql-resources-list">
        <h3 class="sql-resources-title">
            Check out other related resources
        </h3>
        
            <ul class="sql-resources-items">
                
                    
                    
                
                    
                    
                
                    
                    
                
                    
                    
                
                    
                    
                
                    
                    
                        <li class="sql-resources-item">
                            Check out what's new with <a class="sql-resources-link" href="https://channel9.msdn.com/Events/Connect/2016/189" target="_blank">SQL Server + Python on Channel 9</a>
                        </li>
                    
                
                    
                    
                        <li class="sql-resources-item">
                            Browse more SQL Server code samples on our <a class="sql-resources-link" href="https://github.com/Microsoft/sql-server-samples/tree/master/samples/features" target="_blank">GitHub repository</a>
                        </li>
                    
                
                    
                    
                        <li class="sql-resources-item">
                            Learn more about <a class="sql-resources-link" href="https://www.microsoft.com/en-us/sql-server/sql-server-2017" target="_blank">SQL Server 2017</a>
                        </li>
                    
                
                    
                    
                        <li class="sql-resources-item">
                            Get the sample code for this tutorial <a class="sql-resources-link" href="https://github.com/Microsoft/sql-server-samples/tree/master/samples/features/machine-learning-services/python/getting-started/rental-prediction" target="_blank">here</a>
                        </li>
                    
                
                    
                    
                
            </ul>
      
    </div>
</div>

    
  

  <div class="sql-questions">
    <h2 class="sql-questions-title">
        Have Questions?
    </h2>
    <p class="sql-questions-text">
        Happy to help! You can find us on <a href="https://github.com/Microsoft/sql-server-samples/tree/master/samples/tutorials" target="_blank">GitHub</a>, <a href="https://social.msdn.microsoft.com/Forums/en-US/home target="_blank"">MSDN Forums</a>, and StackOverflow. We also monitor the <a href="https://twitter.com/search?q=%23SQLServerDev&amp;src=typd" target="_blank">#SQLServerDev</a> hashtag on Twitter.
    </p>
</div>

  
      <footer class="sql-disqus">
        

      </footer>
  
</article>

      </div>
    </main>

    <footer class="sql-footer">
  




    <div class="sql-footer-copy">
        <a class="sql-footer-link" href="https://go.microsoft.com/?linkid=2028325">Contact us</a> | 
        <a class="sql-footer-link" href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy & cookies</a> | 
        <a class="sql-footer-link" href="https://go.microsoft.com/fwlink/?LinkID=206977">Terms of use</a> | 
        <a class="sql-footer-link" href="https://www.microsoft.com/trademarks">Trademarks</a> | 
        <a class="sql-footer-link" href="https://choice.microsoft.com/">About our ads</a> | 
        Â© 2017 Microsoft 
      <!--
        <a href="#" target="_blank" class="sql-footer-icon fa fa-twitter" aria-hidden="true" style="float:right;"></a>
        <a href="#" target="_blank" class="sql-footer-icon fa fa-github" aria-hidden="true" style="float:right;"></a>
      -->
    </div>

           
</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js" type="text/javascript"></script>
<script src="https://use.fontawesome.com/c7b2a63f93.js"></script>
<script src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/scripts/prism.js" type="text/javascript"></script>
<script src="/en-us/sql-server/developer-get-started/ml-tutorials/assets/scripts/steps.js" type="text/javascript"></script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'Microsoft/mssql-developers'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
  </body>

</html>
